<!DOCTYPE>
<html>
	<head>
		<style>
			html {
				background-color: #eee;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			.card-container {
				margin: 10px auto;
				padding: 0 10px 0 10px;
			}
			.card {
				position: relative;
				background-color: white;
				border-radius: 2px;
				box-shadow: 0 2px 0 0 #ddd;
				font-family: sans-serif;
				font-weight: lighter;
			}
			.card .card-content-padder {
				padding: 15px 20px 15px 15px;
			}
			.card .card-action {
				color: #57f;
				font-size: 0.9em;
				padding: 10px;
			}
			.card .card-action:hover {
				background-color: #f8f8f8;
			}
			.card .menu {
				background-image: url('dropdown.png');
				background-size: 6px 17px;
				width: 6px;
				height: 17px;
				position: absolute;
				top: 10px;
				right: 5px;
			}
			.card .title {
				color: #888;
				font-size: 1.25em;
				line-height: 1.25em;
				margin-bottom: 5px;
			}
			.card .last-done {
				color: #bbb;
				font-size: 0.8em;
			}
			.card .divider {
				height: 1px;
				background-color: #eee;
			}

			#add-button {
				position: fixed;
				bottom: 15px;
				right: 15px;
				background-image: url('add.png');
				background-repeat: no-repeat;
				background-position: center; 
				background-color: #57f;
				height: 60px;
				width: 60px;
				border-radius: 30px;
				box-shadow: 0 2px 1px 0 #bbb;
			}

		</style>
		<link rel='stylesheet' type='text/css' href='reset.css' />
		<meta name='viewport' content='width=device-width, user-scalable=no'>
		<script type='text/javascript' src='jquery-2.1.0.js'></script>
		<script type='text/javascript' src='underscore.js'></script>
		<script type='text/javascript' src='backbone.js'></script>
		<script type='text/javascript' src='backbone.localStorage.js'></script>
	</head>
	<body>
		<div id='cards'></div>

		<div id='add-button'></div>

		<template id='edit-card-template'>
			<div class='card-container'>
				<div class='card'>
					<div class='card-content-padder'>
						<div class='title'>
						</div>
						<div class='last-done'>
						</div>
					</div>
					<div class='divider'></div>
					<div class='card-action'>
						Done
					</div>
					<div class='card-action'>
						Cancel
					</div>
				</div>
			</div>			
		</template>

		<template id='card-template'>
			<div class='card-container'>
				<div class='card'>
					<div class='card-content-padder'>
						<div class='menu'>
						</div>
						<div class='title'>
						</div>
						<div class='last-done'>
						</div>
					</div>
					<div class='divider'></div>
					<div class='card-action'>
						Done
					</div>
				</div>
			</div>
		</template>

		<script type='text/javascript'>
			// Models
			var Action = Backbone.Model.extend({
				defaults: {
					'title': '',
					'lastDone': (new Date).getTime()
				},
				lastDoneDays: function () {
					var milliSince = (new Date).getTime() - this.get('lastDone');
					// Todo: check this should be a floor
					return Math.floor(milliSince/86400000);
				}
			});
			var ActionCollection = Backbone.Collection.extend({
				model: Action,
				localStorage: new Backbone.LocalStorage('ActionCollection'), 
			});
			// Views
			ActionListView = Backbone.View.extend({
				initialize: function () {
					this.model.bind('reset', this.render, this);
					// TODO: only render the new one by rendering a subview and appending it to this
					this.model.bind('add', this.render, this);
				},
				render: function (event) {
					document.querySelector('#cards').innerHTML = '';
					_.each(this.model.models, function (action) {
						var template = document.querySelector('#card-template');
						var titleElem = template.content.querySelector('.title');
						titleElem.innerHTML = action.get('title');
						var lastDoneElem = template.content.querySelector('.last-done');
						lastDoneElem.innerHTML = action.lastDoneDays() + ' days ago';
						var instance = template.content.cloneNode(true);
						document.querySelector('#cards').appendChild(instance);
					});
				}
			});

			var actionCollection = new ActionCollection();
			actionCollection.fetch({
				success:function () {
					actionListView = new ActionListView({model:actionCollection});
					actionListView.render();
				}
			});
			document.querySelector('#submitButton').onclick = function() {
				var title = document.querySelector('#titleInput').value;
				var a = new Action({title: title});
				actionCollection.create(a);
			}
		</script>
	</body>
</html>