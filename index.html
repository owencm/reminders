<!DOCTYPE>
<html>
  <head>
    <style>
      html {
        background-color: #eee;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .card-container {
        margin: 10px auto;
        padding: 0 10px 0 10px;
      }
      .card {
        position: relative;
        background-color: white;
        border-radius: 2px;
        box-shadow: 0 3px 1px -1px #cacaca;
        font-family: 'Roboto', sans-serif;
        font-weight: 100;
      }
      .card .card-content-padder {
        padding: 15px;
      }
      .card .card-action {
        color: #68f;
        font-size: 1.05em;
        padding: 15px 10px;
      }
      .card .menu {
        background-image: url('dropdown.png');
        background-size: 6px 17px;
        width: 6px;
        height: 17px;
        position: absolute;
        top: 10px;
        right: 5px;
      }
      .card .menu:before {
        padding: 15px 20px 15px 15px;
      }
      .card .title {
        color: #777;
        font-size: 1.3em;
        line-height: 1.3em;
        margin-bottom: 5px;
      }
      .card .last-done {
        color: #bbb;
        font-size: 0.8em;
      }
      .card .divider {
        height: 1px;
        background-color: #eaeaea;
      }

      input.holo[type='text'] {
        width: 100%;
        font-family: "Roboto", "Droid Sans", sans-serif;
        font-size: 16px;
        margin: 0;
        padding: 8px 8px 6px 8px;
        position: relative;
        display: block;
        outline: none;
        border: none;
        background: bottom left linear-gradient(#a9a9a9, #a9a9a9) no-repeat, bottom center linear-gradient(#a9a9a9, #a9a9a9) repeat-x, bottom right linear-gradient(#a9a9a9, #a9a9a9) no-repeat;
        background-size: 1px 6px, 1px 1px, 1px 6px;
      }
      input.holo[type='text']:hover, input.holo[type='text']:focus {
        background: bottom left linear-gradient(#0099cc, #0099cc) no-repeat, bottom center linear-gradient(#0099cc, #0099cc) repeat-x, bottom right linear-gradient(#0099cc, #0099cc) no-repeat;
        background-size: 1px 6px, 1px 1px, 1px 6px; 
      } 

      input.holo.title {
        font-size: 1.2em;
      }

    </style>
    <link rel='stylesheet' type='text/css' href='reset.css' />
    <meta name='viewport' content='width=device-width, user-scalable=no'>
    <script type='text/javascript' src='jquery-2.1.0.js'></script>
    <script type='text/javascript' src='underscore.js'></script>
    <script type='text/javascript' src='backbone.js'></script>
    <script type='text/javascript' src='backbone.localStorage.js'></script>
  </head>
  <body>

    <div class='card-container'>
      <div class='card'>
        <form type='submit' onsubmit='document.querySelector("#submitButton").click(); return false;'>
          <div class='card-content-padder'>
            <input type='text' id='titleInput' placeholder='Type intention here' autocomplete='off' autocapitalize='on' class='holo title'></input>
          </div>
          <div class='divider'></div>
          <div class='card-action' id='submitButton'>
            Create
          </div>
        </form>
      </div>
    </div>

    <div id='cards'></div>

    <template id='card'>
      <div class='card-container'>
        <div class='card'>
          <div class='card-content-padder'>
            <div class='menu'>
            </div>
            <div class='title'>
            </div>
            <div class='last-done'>
            </div>
          </div>
          <div class='divider'></div>
          <div class='card-action'>
            Mark done
          </div>
        </div>
      </div>
    </template>

    <script type='text/javascript'>
      // Models
      var Action = Backbone.Model.extend({
        defaults: {
          'title': '',
          'lastDone': (new Date).getTime()
        },
        lastDoneDays: function () {
          var milliSince = (new Date).getTime() - this.get('lastDone');
          // Todo: check this should be a floor
          return Math.floor(milliSince/86400000);
        }
      });
      var ActionCollection = Backbone.Collection.extend({
        model: Action,
        localStorage: new Backbone.LocalStorage('ActionCollection'), 
      });
      // Views
      ActionListView = Backbone.View.extend({
        initialize: function () {
          this.model.bind('reset', this.render, this);
          // TODO: only render the new one by rendering a subview and appending it to this
          this.model.bind('add', this.render, this);
        },
        render: function (event) {
          document.querySelector('#cards').innerHTML = '';
          _.each(this.model.models, function (action) {
            var template = document.querySelector('template');
            var titleElem = template.content.querySelector('.title');
            titleElem.innerHTML = action.get('title');
            var lastDoneElem = template.content.querySelector('.last-done');
            lastDoneElem.innerHTML = action.lastDoneDays() + ' days ago';
            var instance = template.content.cloneNode(true);
            document.querySelector('#cards').appendChild(instance);
          });
        }
      });

      var actionCollection = new ActionCollection();
          actionCollection.fetch({
              success:function () {
                  actionListView = new ActionListView({model:actionCollection});
                  actionListView.render();
              }
          });
      document.querySelector('#submitButton').onclick = function() {
        var title = document.querySelector('#titleInput').value;
        var a = new Action({title: title});
        actionCollection.create(a);
      }

      // This may be needed for form submitting
      // var hideKeyboard = function (element) {
      //   element.attr('readonly', 'readonly'); // Force keyboard to hide on input field.
      //   element.attr('disabled', 'true'); // Force keyboard to hide on textarea field.
      //   setTimeout(function() {
      //       element.blur();  //actually close the keyboard
      //       // Remove readonly attribute after keyboard is hidden.
      //       element.removeAttr('readonly');
      //       element.removeAttr('disabled');
      //   }, 100);
      // }
    </script>
  </body>
</html>